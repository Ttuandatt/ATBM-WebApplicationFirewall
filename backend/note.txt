       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚     User      â”‚
       â”‚ (trÃ¬nh duyá»‡t) â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTP Request
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     WAF       â”‚
        â”‚   (waf.py)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     - Náº¿u match rule trong rules.json â†’ block (403) vÃ  log láº¡i vÃ o logs/waf.log.
     - Náº¿u khÃ´ng match â†’ forward Ä‘áº¿n backend_app.py (port 5001).

                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Demo Backend  â”‚
         â”‚ (backend_app) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Response    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                    Admin Side (port 5002)                 â”‚
   â”‚                                                           â”‚
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
   â”‚   â”‚   Admin UI    â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚  Admin API    â”‚               â”‚
   â”‚   â”‚ (React/HTML)  â”‚       â”‚ (admin_api.py)â”‚               â”‚
   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
   â”‚                                   â”‚                       â”‚
   â”‚     GET/POST /rules               â”‚  POST /analyze        â”‚
   â”‚     GET /logs                     â–¼                       â”‚
   â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
   â”‚                              â”‚   Analyzer    â”‚            â”‚
   â”‚                              â”‚ (analyzer.py) â”‚            â”‚
   â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
   â”‚                                      â”‚                    â”‚
   â”‚                                 Update rules.json         â”‚
   â”‚                                 (tá»± Ä‘á»™ng sinh regex)      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”‘ Giáº£i thÃ­ch flow:

1. User gá»­i request â†’ Ä‘i qua waf.py.
- Náº¿u match rule trong rules.json â†’ block (403) vÃ  log láº¡i.
- Náº¿u khÃ´ng match â†’ forward Ä‘áº¿n backend_app.py (port 5001).

2. WAF log lÆ°u vÃ o logs/waf.log.

3. Admin API (5002) cho Admin UI gá»i:
- /rules: xem / thÃªm / xÃ³a rule.
- /logs: xem log má»›i nháº¥t.
- /analyze: trigger analyzer Ä‘á»c log vÃ  cáº­p nháº­t rules.json.

4. Analyzer.py Ä‘á»c log, tÃ¬m pattern táº¥n cÃ´ng â†’ sinh regex rule má»›i â†’ append vÃ o rules.json.




--------------------------------------
CÃ¡ch cháº¡y (local, trong PyCharm)

Backend

1. Táº¡o virtualenv vÃ  cÃ i dependency (vÃ­ dá»¥ trong backend/):

python -m venv venv
venv\Scripts\activate -> kÃ­ch hoáº¡t vÃ o cháº¿ Ä‘á»™ virtual environment (venv) cá»§a Python. ThoÃ¡t venv: deactivate
pip install -r requirements.txt
# náº¿u báº¡n chÆ°a cÃ³, requirements.txt vÃ­ dá»¥:
# flask
# flask-cors


2. Cháº¡y admin_api.py:

python admin_api.py

=> Admin API láº¯ng nghe http://127.0.0.1:5002.


3. Cháº¡y backend_app.py (port 5001) vÃ  waf.py (port 5000) nhÆ° báº¡n Ä‘Ã£ cÃ³:

python backend_app.py
python waf.py


Trong PyCharm:

Báº¡n cÃ³ thá»ƒ táº¡o 2 (hoáº·c 3) Run Configurations kiá»ƒu "Python" Ä‘á»ƒ cháº¡y backend_app.py, waf.py, admin_api.py. PyCharm tÃ­ch há»£p virtualenv; chá»n interpreter lÃ  venv cá»§a project. Cháº¡y tá»«ng config trong cÃ¡c tab run khÃ¡c nhau.




CÃ¡c pattern máº«u Ä‘á»ƒ thá»­:
,
  {
    "id": 11,
    "type": "CRLF_INJECTION",
    "pattern": "(?:%0d%0a|\\r\\n).*(?:Content-Type:|Set-Cookie:|Location:)",
    "enabled": true,
    "source": "seed",
    "comment": "PhÃ¡t hiá»‡n CRLF + header injection (vÃ­ dá»¥ chÃ¨n 'Set-Cookie' hoáº·c 'Location'). Báº¯t cáº£ dáº¡ng encode (%0d%0a)."
  },
  {
    "id": 12,
    "type": "XPATH_LDAP_INJECTION",
    "pattern": "(?:\\b(xpath|ldap)\\b|filter=\\(|\\[\\*\\])",
    "enabled": false,
    "source": "seed",
    "comment": "Pattern gá»£i Ã½ XPath/LDAP injection vectors. DÃ¹ng Ä‘á»ƒ log/alert náº¿u app dÃ¹ng XML/LDAP queries; dá»… FP, báº­t tháº­n trá»ng."
  },
  {
    "id": 13,
    "type": "SUSPICIOUS_LONG_TOKEN",
    "pattern": "[A-Za-z0-9\\-_]{80,}",
    "enabled": false,
    "source": "seed",
    "comment": "Chuá»—i dÃ i kÃ½ tá»± alphanumeric (>=80) cÃ³ thá»ƒ lÃ  payload mÃ£ hÃ³a / token / shellcode â€” chá»‰ log vÃ¬ dá»… FP (vÃ­ dá»¥ long tokens)."
  },
  {
    "id": 14,
    "type": "SQL_COMMENT_OBFUSCATION",
    "pattern": "(?:/\\*.*?\\*/)",
    "enabled": false,
    "source": "seed",
    "comment": "PhÃ¡t hiá»‡n SQL comment obfuscation (/*...*/), káº» táº¥n cÃ´ng cÃ³ thá»ƒ chÃ¨n comment Ä‘á»ƒ nÃ© má»™t sá»‘ bá»™ lá»c. DÃ¹ng Ä‘á»ƒ log/analyze."
  },
  {
    "id": 15,
    "type": "SUSPICIOUS_FILE_EXT",
    "pattern": "(?:\\.phps?|\\.phtml|\\.jsp|\\.asp[x]?)$",
    "enabled": true,
    "source": "seed",
    "comment": "Cháº·n upload hoáº·c access Ä‘áº¿n file vá»›i extension thá»±c thi server-side (php, phtml, jsp, asp) â€” cÃ³ thá»ƒ ngÄƒn ngÆ°á»i upload code."
  },
  {
    "id": 16,
    "type": "regex",
    "pattern": "([;&|]{1,2}\\s*(cat|ls|whoami|id|rm)\\b)",
    "enabled": true,
    "source": "seed",
    "comment": "PhÃ¡t hiá»‡n Command Injection â€” khi ngÆ°á»i dÃ¹ng cá»‘ gáº¯ng thá»±c thi lá»‡nh há»‡ thá»‘ng."
  },
  {
    "id": 17,
    "type": "XSS_ATTACK",
    "pattern": "<script.*?>.*?</script>",
    "enabled": true,
    "source": "analyzer",
    "comment": "PhÃ¡t hiá»‡n Ä‘oáº¡n mÃ£ XSS chá»©a tháº» <script>."
  }


  12/10/2025
  Äá» cháº¡y demo_attacks.ps1, nháº­p cÃ¡c lá»‡nh:
- Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
- ./demo_attacks.ps1

[PowerShell Script demo_attacks.ps1]
        â”‚
        â–¼
Gá»­i request thá»­ nghiá»‡m (XSS, SQLi, CRLF...) â†’ http://127.0.0.1:5000
        â”‚
        â–¼
 [waf.py]  â€” Web Application Firewall
     â”œâ”€ Äá»c rules.json
     â”œâ”€ Kiá»ƒm tra pattern + heuristic
     â”œâ”€ Náº¿u khá»›p â†’ BLOCK + ghi log JSON (waf.log)
     â””â”€ Náº¿u há»£p lá»‡ â†’ chuyá»ƒn tiáº¿p request tá»›i backend_app.py
        â”‚
        â–¼
 [backend_app.py] â€” Flask demo app (giáº£ láº­p web bÃ¡n Ä‘iá»‡n thoáº¡i)
     â”œâ”€ /search?q=... â†’ render HTML káº¿t quáº£
     â””â”€ /login â†’ nháº­n form Ä‘Äƒng nháº­p demo
        â”‚
        â–¼
 [admin_api.py] â€” REST API quáº£n trá»‹
     â”œâ”€ /api/rules â†’ xem rule hiá»‡n cÃ³
     â”œâ”€ /api/analyze â†’ cháº¡y analyzer.py sinh rule tá»± Ä‘á»™ng
     â””â”€ /api/logs â†’ Ä‘á»c waf.log (PowerShell script gá»i Ä‘á»ƒ xem log)