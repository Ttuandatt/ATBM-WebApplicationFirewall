# ATBM-WebApplicationFirewall

# H∆∞·ªõng d·∫´n ch·∫°y th·ª≠ code v0.0
### 1. Ch·∫°y backend
- Chuy·ªÉn ƒë·∫øn directory backend: ```cd backend```
- Ch·∫°y file waf.py: ```python waf.py```
- Ch·∫°y file backend_app.py: ```python backend_app.py```
- Ch·∫°y file admin_api.py: ```python admin_api.py```
### 2. Ch·∫°y front end
- Chuy·ªÉn ƒë·∫øn directory frontend: ```cd frontend```
- ```npm run dev```
### 3. Ch·∫°y admin-ui
- Chuy·ªÉn ƒë·∫øn directory admin-ui: ```cd admin-ui```
- Ch·∫°y giao di·ªán Admin Dashboard: ```python -m http.server 8080```

*** N·∫øu c√≥ l·ªói th√¨ search ChatGPT ƒë·ªÉ config nh√© c·∫£ nh√† ***

# WAF Informtaion

### 1. WAF n√†y thu·ªôc lo·∫°i g√¨?

- Lo·∫°i: Rule-based Web Application Firewall (t∆∞·ªùng l·ª≠a ·ª©ng d·ª•ng web d·ª±a tr√™n lu·∫≠t).

- C∆° ch·∫ø: D√πng regex pattern matching ƒë·ªÉ d√≤ t√¨m payload ƒë·ªôc h·∫°i trong HTTP request (v√≠ d·ª• XSS <script>, SQLi UNION SELECT).

- Chu·∫©n/Nguy√™n l√Ω: N√≥ tu√¢n theo m√¥ h√¨nh OWASP CRS (Core Rule Set) c∆° b·∫£n ‚Äì t·ª©c l√† ph√°t hi·ªán d·ª±a v√†o signature/regex thay v√¨ ML hay h√†nh vi.

*üëâ Nghƒ©a l√†: n√≥ kh√¥ng ph·∫£i network firewall (L3/L4), m√† thu·ªôc l·ªõp Application Firewall (L7), c·ª• th·ªÉ h∆°n l√† WAF theo chu·∫©n OWASP Top 10 (SQLi, XSS, RFI/LFI, Path Traversal...).*

### 2. So v·ªõi c√°c chu·∫©n/c√¥ng ngh·ªá ngo√†i th·ª±c t·∫ø

- ModSecurity (chu·∫©n ph·ªï bi·∫øn nh·∫•t, t√≠ch h·ª£p CRS c·ªßa OWASP): c≈©ng ho·∫°t ƒë·ªông rule-based, nh∆∞ng c√≥ h√†ng ngh√¨n rule, k√®m theo anomaly scoring, whitelist/blacklist ph·ª©c t·∫°p h∆°n.

- AWS WAF / Cloudflare WAF: c≈©ng c√≥ core rule set d·ª±a tr√™n regex + managed rules, nh∆∞ng h·ªç c√≥ th√™m AI/ML, scoring, geo-block, bot-detection.

- WAF hi·ªán t·∫°i ƒëang l√†m: phi√™n b·∫£n prototype nh·∫π, d√πng seed rules JSON ƒë·ªÉ match request payload. N√≥ t∆∞∆°ng ƒë∆∞∆°ng m·ªôt b·∫£n mini-ModSecurity, ph√π h·ª£p ƒë·ªÉ h·ªçc v√† th·ª≠ nghi·ªám.

### 3. C√°c th√†nh ph·∫ßn h·ªá th·ªëng hi·ªán t·∫°i ƒëang c√≥

- Frontend: Web app (gi·∫£ l·∫≠p user g·ª≠i request).

- Backend (WAF proxy):

  - Nh·∫≠n HTTP request t·ª´ user ‚Üí ki·ªÉm tra payload d·ª±a v√†o rules.json.

  - N·∫øu match rule ‚Üí ch·∫∑n + log l·∫°i (payload, URL, IP, timestamp).

  - N·∫øu kh√¥ng match ‚Üí forward request ƒë·∫øn ·ª©ng d·ª•ng ƒë√≠ch (gi·ªëng reverse proxy).

- Admin-UI:

  - Giao di·ªán qu·∫£n l√Ω rules.

  - Load rules t·ª´ admin_api.py (/rules endpoint).

  - Cho ph√©p b·∫≠t/t·∫Øt, th√™m rule m·ªõi.

### 4. Chu·∫©n ho·∫°t ƒë·ªông / Flow x·ª≠ l√Ω (chu·∫©n WAF c∆° b·∫£n)

- User ‚Üí g·ª≠i request (c√≥ th·ªÉ ch·ª©a attack payload).

- Request ƒëi qua WAF proxy (backend).

- So s√°nh request content v·ªõi rules trong rules.json.

- N·∫øu match: block/log.

- N·∫øu kh√¥ng: forward ƒë·∫øn app th·∫≠t.

- Admin ‚Üí d√πng Admin-UI ƒë·ªÉ qu·∫£n l√Ω rules.

- Admin-UI g·ªçi API (/rules) t·ª´ admin_api.py.

- Rules ƒë∆∞·ª£c c·∫≠p nh·∫≠t v√†o rules.json.

- Backend reload ho·∫∑c ƒë·ªçc rules.json ƒë·ªÉ update b·ªô l·ªçc.

### 5. ƒêi·ªÉm m·∫°nh v√† h·∫°n ch·∫ø

**‚úÖ ƒêi·ªÉm m·∫°nh:**

Nh·∫π, d·ªÖ hi·ªÉu, minh h·ªça nguy√™n l√Ω rule-based WAF.

C√≥ UI qu·∫£n l√Ω rule ‚Üí tr·ª±c quan.

C√≥ logging request ƒë·ªÉ sau n√†y ph√¢n t√≠ch (c√≥ th·ªÉ l√†m auto rule-gen).

**‚ö†Ô∏è H·∫°n ch·∫ø (so v·ªõi chu·∫©n th·ª±c t·∫ø):**

Ch·ªâ rule-based, ch∆∞a c√≥ anomaly scoring.

Ch∆∞a c√≥ t√≠nh nƒÉng negative security model (whitelist), ch·ªâ m·ªõi positive (block khi kh·ªõp regex).

Ch∆∞a x·ª≠ l√Ω t·ªët false positive/false negative.

Ch∆∞a c√≥ high-performance engine (ModSecurity vi·∫øt C, t√≠ch h·ª£p v√†o Nginx/Apache, r·∫•t nhanh).


### Ki·∫øn tr√∫c Web b√°n s√°ch + WAF

üë©‚Äçüíª User (kh√°ch h√†ng)
       |
       v
 üåê Frontend (React + Vite UI)
 http://localhost:5173
       |
       v
 üî∞ WAF Proxy (waf.py)   <--- so kh·ªõp v·ªõi rules.json
       |    (block n·∫øu match rule)
       v
 üñ•Ô∏è Backend App (backend_app.py)
       |--- üìö Database (Books, Users, Orders)
       |
       v
  Tr·∫£ d·ªØ li·ªáu (s√°ch, gi·ªè h√†ng, thanh to√°n)


### Qu·∫£n tr·ªã b·∫£o m·∫≠t (Admin)

üë®‚Äçüíº Admin
       |
       v
 üåê Admin-UI (index.html)
 http://localhost:8080
       |
       v
 üõ†Ô∏è Admin API (admin_api.py)
       |
       v
 üìÑ rules.json  <--- n∆°i l∆∞u tr·ªØ rules
       |
       v
 üî∞ WAF Proxy (waf.py)  <--- ƒë·ªçc rules.json ƒë·ªÉ update filter


### üìë Gi·∫£i th√≠ch lu·ªìng

1. Kh√°ch h√†ng truy c·∫≠p frontend ƒë·ªÉ mua s√°ch.

- Request g·ª≠i qua waf.py.

- waf.py ki·ªÉm tra rules.json.

- N·∫øu h·ª£p l·ªá ‚Üí chuy·ªÉn v√†o backend_app.py.

- backend_app.py truy v·∫•n database ‚Üí tr·∫£ k·∫øt qu·∫£ v·ªÅ frontend.

2. Admin m·ªü Admin-UI ƒë·ªÉ qu·∫£n l√Ω rules.

- G·ªçi API t·ªõi admin_api.py.

- admin_api.py c·∫≠p nh·∫≠t rules.json.

- waf.py ƒë·ªçc rules.json ‚Üí √°p d·ª•ng rule m·ªõi.



# Demo Scenario

### 0) Chu·∫©n b·ªã (kh·ªüi ƒë·ªông services)

- M·ªü 3 terminal (ho·∫∑c 3 Run config) v√† trong m·ªói terminal cd backend v√† activate venv n·∫øu c·∫ßn.

- Terminal A ‚Äî WAF:

```
cd ATBM-WebApplicationFirewall/backend
# (n·∫øu ch∆∞a active venv) venv\Scripts\activate  (Windows)  ho·∫∑c  source venv/bin/activate
python waf.py
# WAF l·∫Øng nghe: http://127.0.0.1:5000
```

- Terminal B ‚Äî Backend app (·ª©ng d·ª•ng b√°n s√°ch gi·∫£ l·∫≠p):
```
cd ATBM-WebApplicationFirewall/backend
python backend_app.py
# Backend app l·∫Øng nghe: http://127.0.0.1:5001
```

- Terminal C ‚Äî Admin API:
```
cd ATBM-WebApplicationFirewall/backend
python admin_api.py
# Admin API l·∫Øng nghe: http://127.0.0.1:5002
```

- (Optional) Ch·∫°y frontend React (n·∫øu mu·ªën demo UI ng∆∞·ªùi d√πng):
```
cd ATBM-WebApplicationFirewall/frontend
npm install   # n·∫øu ch∆∞a c√†i
npm run dev   # m·ªü http://localhost:5173
```

- (Optional) Ch·∫°y admin-ui (dashboard tƒ©nh):
```
cd ATBM-WebApplicationFirewall/admin-ui
python -m http.server 8080
# r·ªìi m·ªü http://localhost:8080
```

### 1) Scenario A ‚Äî Truy c·∫≠p b√¨nh th∆∞·ªùng (kh√¥ng b·ªã block)

**M·ª•c ti√™u**: ch·ª©ng minh request ƒëi qua WAF v√† ƒë∆∞·ª£c forward t·ªõi backend_app (tr·∫£ n·ªôi dung ·ª©ng d·ª•ng).

**C√°ch 1 ‚Äî D√πng tr√¨nh duy·ªát (th√≠ch h·ª£p khi d√πng frontend React)**

- M·ªü http://localhost:5173 (frontend) ho·∫∑c test tr·ª±c ti·∫øp WAF:

  - M·ªü http://127.0.0.1:5000/search?q=iphone trong tr√¨nh duy·ªát.

- K·∫øt qu·∫£ mong ƒë·ª£i: b·∫°n th·∫•y n·ªôi dung t·ª´ backend_app.py ‚Äî v√≠ d·ª• Search Results for: iphone.

**C√°ch 2 ‚Äî D√πng curl (ch·∫Øc ch·∫Øn, terminal)**
```
curl -i "http://127.0.0.1:5000/search?q=iphone"
```

- Expected (HTTP):

  - Status 200 OK

  - Body ch·ª©a: Search Results for: iphone

**Ki·ªÉm tra log**

M·ªü file log ho·∫∑c d√πng admin API:
```
# xem log cu·ªëi
tail -n 20 backend/logs/waf.log

# ho·∫∑c g·ªçi admin_api
curl "http://127.0.0.1:5002/api/logs"
```

- Expected log entry: m·ªôt d√≤ng ALLOWED: <src_ip> /search?... (WAF ghi allowed).

### 2) Scenario B ‚Äî Vi ph·∫°m match rule (b·ªã block)

**M·ª•c ti√™u**: M√¥ ph·ªèng c√°c request ch·ª©a payload t·∫•n c√¥ng (tr√πng v·ªõi regex rule trong rules.json) ‚Üí
WAF ph·∫£i ph√°t hi·ªán, ch·∫∑n (HTTP 403), ghi log BLOCKED, v√† kh√¥ng forward t·ªõi backend.

### ‚öîÔ∏è 1. Cross-Site Scripting (XSS Attack)

M√¥ ph·ªèng h√†nh vi:

K·∫ª t·∫•n c√¥ng c·ªë g·∫Øng ch√®n th·∫ª <script> v√†o n·ªôi dung ng∆∞·ªùi d√πng g·ª≠i (form b√¨nh lu·∫≠n, √¥ t√¨m ki·∫øm, v.v.).
M·ª•c ti√™u l√† khi·∫øn tr√¨nh duy·ªát n·∫°n nh√¢n th·ª±c thi JavaScript ƒë·ªôc h·∫°i.

Rule t∆∞∆°ng ·ª©ng trong rules.json:
```
{
    "id": 1,
    "type": "XSS",
    "pattern": "<script[^>]*?>[\\s\\S]*?<\\/script>",
    "enabled": true,
    "source": "seed",
    "comment": "Ch·∫∑n payload XSS d·∫°ng <script>...</script>. D√πng ƒë·ªÉ ph√°t hi·ªán script tag tr·ª±c ti·∫øp trong body/query. (FP risk: th·∫•p n·∫øu ƒë√£ decode input)."
  }
```

Command demo:
```
curl -i -X POST "http://127.0.0.1:5000/comment" \
  -H "Content-Type: text/plain" \
  --data "<script>alert('xss-demo')</script>"
```

Expected (HTTP response):
```
HTTP/1.1 403 Forbidden
Content-Type: text/plain

Blocked by RuleForge WAF
```

Expected log entry (trong backend/logs/waf.log ho·∫∑c /api/logs):
```
{"timestamp": "...", "src_ip": "127.0.0.1", "path": "/comment", "payload": "<script>alert('xss-demo')</script>", "matched_rule": "(<script>.*?</script>)", "action": "BLOCKED"}
```

### üß® 2. SQL Injection (SQLi Attack)

M√¥ ph·ªèng h√†nh vi:
K·∫ª t·∫•n c√¥ng ch√®n c√¢u l·ªánh SQL v√†o input ƒë·ªÉ tr√≠ch xu·∫•t d·ªØ li·ªáu t·ª´ database (nh∆∞ users ho·∫∑c passwords).

Rule t∆∞∆°ng ·ª©ng trong rules.json:
```
{
    "id": 3,
    "type": "SQLi",
    "pattern": "(?:union\\s+select\\b)",
    "enabled": true,
    "source": "seed",
    "comment": "Ph√°t hi·ªán pattern 'UNION SELECT' ‚Äì ch·ªâ d√πng khi normalized v√† case-insensitive. R·∫•t hi·ªáu qu·∫£ v·ªõi SQLi d·∫°ng union-based."
  }
```

Command demo:
```
curl -i "http://127.0.0.1:5000/search?q=1 UNION SELECT username,password FROM users"
```

Expected (HTTP response):
```
HTTP/1.1 403 Forbidden
Content-Type: text/plain

Blocked by RuleForge WAF
```

Expected log entry:
```
{"timestamp": "...", "src_ip": "127.0.0.1", "path": "/search", "payload": "1 UNION SELECT username,password FROM users", "matched_rule": "(UNION.*SELECT.*FROM)", "action": "BLOCKED"}
```

### üß± 3. Command Injection (CMD Injection)

M√¥ ph·ªèng h√†nh vi:
K·∫ª t·∫•n c√¥ng c·ªë g·∫Øng ch√®n l·ªánh h·ªá th·ªëng (;, &&, |, v.v.) v√†o input ‚Äî v√≠ d·ª• khi backend g·ªçi os.system() ho·∫∑c subprocess.

Rule t∆∞∆°ng ·ª©ng trong rules.json:
```
{
  "id": 3,
  "type": "regex",
  "pattern": "([;&|]{1,2}\\s*(cat|ls|whoami|id|rm)\\b)",
  "enabled": true,
  "source": "seed",
  "comment": "Ph√°t hi·ªán Command Injection ‚Äî khi ng∆∞·ªùi d√πng c·ªë g·∫Øng th·ª±c thi l·ªánh h·ªá th·ªëng."
}
```

Command demo:
```
curl -i "http://127.0.0.1:5000/search?q=iphone;ls"
```

Expected (HTTP response):
```
HTTP/1.1 403 Forbidden
Content-Type: text/plain

Blocked by RuleForge WAF
```

Expected log entry:
```
{"timestamp": "...", "src_ip": "127.0.0.1", "path": "/search", "payload": "iphone;ls", "matched_rule": "([;&|]{1,2}\\s*(cat|ls|whoami|id|rm)\\b)", "action": "BLOCKED"}
```

---

# FLASK
### üß© 1. Flask l√† g√¨?

Flask l√† m·ªôt web framework vi·∫øt b·∫±ng Python, d√πng ƒë·ªÉ:

- X√¢y d·ª±ng web server (m√°y ch·ªß web nh·ªè g·ªçn)

- T·∫°o API (Application Programming Interface) ‚Äî gi√∫p frontend (HTML/JS) giao ti·∫øp v·ªõi backend

- X·ª≠ l√Ω HTTP requests (GET, POST, PUT, DELETE,...)

- Tr·∫£ v·ªÅ d·ªØ li·ªáu JSON ho·∫∑c giao di·ªán HTML

üëâ T√≥m g·ªçn: Flask gi√∫p Python ‚Äún√≥i chuy·ªán‚Äù v·ªõi tr√¨nh duy·ªát, v√† l√† b·ªô n√£o ƒëi·ªÅu ph·ªëi logic backend.

### ‚öôÔ∏è 2. Flask ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?
üîÅ Chu tr√¨nh ho·∫°t ƒë·ªông c∆° b·∫£n:

- 1Ô∏è‚É£ Frontend (tr√¨nh duy·ªát / HTML) g·ª≠i request HTTP ƒë·∫øn Flask (v√≠ d·ª•: GET /api/rules)
- 2Ô∏è‚É£ Flask nh·∫≠n request ‚Üí ch·∫°y h√†m Python t∆∞∆°ng ·ª©ng (route handler)
- 3Ô∏è‚É£ Flask x·ª≠ l√Ω logic: ƒë·ªçc file, ch·∫°y script, truy v·∫•n DB,...
- 4Ô∏è‚É£ Flask tr·∫£ k·∫øt qu·∫£ (HTML ho·∫∑c JSON) v·ªÅ cho frontend
- 5Ô∏è‚É£ Frontend hi·ªÉn th·ªã k·∫øt qu·∫£ cho ng∆∞·ªùi d√πng

### üìò 3. Vai tr√≤ c·ªßa Flask trong project RuleForge

Trong project c·ªßa ta, Flask (file admin_api.py) ƒë√≥ng vai tr√≤ nh∆∞ ‚ÄúAPI Server‚Äù cho trang qu·∫£n tr·ªã RuleForge Admin UI.
C·ª• th·ªÉ:

|       Th√†nh ph·∫ßn	      |                         Vai tr√≤                             |
|---------------------------------------------------------------------------------------|
|  admin_api.py (Flask)   | 	Backend API ‚Äì ƒë·ªçc d·ªØ li·ªáu rule, log, ch·∫°y analyzer      |
|      admin-ui/	      |   Frontend ‚Äì giao di·ªán ng∆∞·ªùi d√πng qu·∫£n tr·ªã hi·ªÉn th·ªã d·ªØ li·ªáu |
|      rules.json         |      	C∆° s·ªü d·ªØ li·ªáu rule (m·∫´u t·∫•n c√¥ng WAF)               |
|         waf.log         |     	File l∆∞u log truy c·∫≠p (ghi l·∫°i h√†nh vi b·ªã ch·∫∑n)     |
|      analyzer.py        |	      Script t·ª± ƒë·ªông ph√¢n t√≠ch log ‚Üí t·∫°o rule m·ªõi           |


### üåê 4. Lu·ªìng ho·∫°t ƒë·ªông c·ªßa h·ªá th·ªëng

D∆∞·ªõi ƒë√¢y l√† s∆° ƒë·ªì lu·ªìng ho·∫°t ƒë·ªông t·ªïng th·ªÉ trong project c·ªßa b·∫°n:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Ng∆∞·ªùi d√πng (Admin UI)       ‚îÇ
‚îÇ  ‚Üí index.html, script.js     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ ‚ë† G·ª≠i request HTTP
             ‚îÇ   (GET /api/rules, GET /api/logs, GET /api/analyze)
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Flask server (admin_api.py)  ‚îÇ
‚îÇ  - X·ª≠ l√Ω API request         ‚îÇ
‚îÇ  - ƒê·ªçc rules.json            ‚îÇ
‚îÇ  - ƒê·ªçc logs/waf.log          ‚îÇ
‚îÇ  - G·ªçi analyzer.py           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ ‚ë° X·ª≠ l√Ω logic b·∫±ng Python
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  D·ªØ li·ªáu h·ªá th·ªëng backend    ‚îÇ
‚îÇ  - rules.json                ‚îÇ
‚îÇ  - logs/waf.log              ‚îÇ
‚îÇ  - analyzer.py               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ ‚ë¢ Tr·∫£ k·∫øt qu·∫£ JSON
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend nh·∫≠n d·ªØ li·ªáu JSON  ‚îÇ
‚îÇ  - script.js x·ª≠ l√Ω JSON      ‚îÇ
‚îÇ  - Render ra b·∫£ng HTML       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üß† 5. Flask trong project RuleForge gi√∫p √≠ch nh∆∞ th·∫ø n√†o?
|          M·ª•c ti√™u          |	                    Flask ƒë·∫£m nh·∫≠n                            |
|---------------------------------------------------------------------------------------------|
|    Xem danh s√°ch rules     |      /api/rules ƒë·ªçc file rules.json, tr·∫£ v·ªÅ JSON               |
|    Xem log ho·∫°t ƒë·ªông       |	    /api/logs ƒë·ªçc file waf.log, tr·∫£ v·ªÅ log                    |
|    Ch·∫°y ph√¢n t√≠ch          |     	/api/analyze g·ªçi analyzer.py sinh rule m·ªõi                |
|  Giao ti·∫øp v·ªõi giao di·ªán	 |      Cho ph√©p admin-ui (HTML/JS) truy c·∫≠p d·ªØ li·ªáu qua HTTP     |
|      B·∫£o v·ªá CORS	         | D√πng flask_cors.CORS(app) cho ph√©p frontend kh√°c port truy c·∫≠p |


### üí° 6. V√≠ d·ª• c·ª• th·ªÉ v·ªÅ ho·∫°t ƒë·ªông

Khi ta nh·∫•n n√∫t ‚ÄúLoad Rules‚Äù tr√™n giao di·ªán:

1Ô∏è‚É£ Giao di·ªán g·ªçi JS:

```
fetch("http://127.0.0.1:5002/api/rules")
```

2Ô∏è‚É£ Flask nh·∫≠n request /api/rules ‚Üí ch·∫°y:
```
@app.route("/api/rules", methods=["GET"])
def get_rules():
    with open("rules.json") as f:
        return jsonify(json.load(f))
```

3Ô∏è‚É£ Flask tr·∫£ v·ªÅ:
```
[
  {"id": 1, "type": "SQLi", "pattern": "UNION SELECT", "enabled": true}
]
```

4Ô∏è‚É£ JavaScript nh·∫≠n JSON ‚Üí hi·ªÉn th·ªã trong <table>.

### üß© 7. So s√°nh Flask v·ªõi c√°c framework kh√°c
|   Framework	|   Ng√¥n ng·ªØ   |            ƒê·∫∑c ƒëi·ªÉm                   |
|----------------------------------------------------------------------|
|     Flask	    |    Python    |   Nh·∫π, linh ho·∫°t, d·ªÖ d√πng             |
|     Django	|    Python    |   M·∫°nh h∆°n, c√≥ ORM v√† admin site s·∫µn  |
|   Express.js	|   JavaScript |   Gi·ªëng Flask nh∆∞ng ch·∫°y tr√™n Node.js |
|   Spring Boot | 	  Java     |   Cho ·ª©ng d·ª•ng l·ªõn, enterprise-scale  |


### ‚úÖ K·∫øt lu·∫≠n

- Flask = B·ªô n√£o backend c·ªßa RuleForge.

- N√≥ nh·∫≠n request t·ª´ frontend, x·ª≠ l√Ω d·ªØ li·ªáu rule & log, v√† g·ª≠i ph·∫£n h·ªìi l·∫°i.

- Nh·ªù Flask, bta c√≥ th·ªÉ t√°ch bi·ªát frontend (giao di·ªán) v√† backend (x·ª≠ l√Ω d·ªØ li·ªáu), t·∫°o ra m·ªôt h·ªá th·ªëng c√≥ c·∫•u tr√∫c r√µ r√†ng, d·ªÖ m·ªü r·ªông.


---

# Demo Command

### C√°c l·ªánh PowerShell (v√† t∆∞∆°ng ƒë∆∞∆°ng curl) ƒë·ªÉ demo t·ª´ng ki·ªÉu vi ph·∫°m t∆∞∆°ng ·ª©ng v·ªõi c√°c rule s·ªë 11‚Üí17 (s·∫Ω t·∫°o) trong rules.json. Tr∆∞·ªõc khi ch·∫°y, ch·∫Øc ch·∫Øn ƒë√£ kh·ªüi ƒë·ªông:

- WAF: python backend/waf.py (port 5000)

- Backend app: python backend/backend_app.py (port 5001)

- Admin API: python backend/admin_api.py (port 5002)

M·ªói l·ªánh s·∫Ω g·ªçi WAF (http://127.0.0.1:5000/ ...) ‚Äî n·∫øu rule kh·ªõp, WAF tr·∫£ 403 v√† ghi log JSON v√†o backend/logs/waf.log. Sau m·ªói test, c√≥ th·ªÉ ki·ªÉm tra log qua Admin API:
```
# Xem logs (PowerShell)
Invoke-RestMethod -Uri "http://127.0.0.1:5002/api/logs" -Method Get

# Ho·∫∑c d√πng curl
curl "http://127.0.0.1:5002/api/logs"
```

### 1) CRLF / Header injection (rule id 11)

M·ª•c ti√™u: ch√®n chu·ªói CRLF (%0d%0a ho·∫∑c \r\n) + header t√™n nh∆∞ Set-Cookie hay Location. M√¥ ph·ªèng header injection / HTTP response splitting ‚Äî k·∫ª t·∫•n c√¥ng c·ªë g·∫Øng ch√®n CRLF (%0d%0a ho·∫∑c \r\n) ti·∫øp theo l√† m·ªôt header (v√≠ d·ª• Set-Cookie: ho·∫∑c Location:) ƒë·ªÉ ch√®n header gi·∫£, thao t√∫ng cookie ho·∫∑c redirect ng∆∞·ªùi d√πng.

Rule li√™n quan: CRLF_INJECTION

Pattern: (?:%0d%0a|\r\n).*(?:Content-Type:|Set-Cookie:|Location:)

C√°ch ho·∫°t ƒë·ªông & l∆∞u √Ω:

- G·ª≠i trong query v√¨ d·ªÖ quan s√°t; WAF s·∫Ω URL-decode n·ªôi dung tr∆∞·ªõc khi so kh·ªõp.

- N·∫øu rule b·∫≠t ‚Üí WAF tr·∫£ 403 + JSON l√Ω do, ƒë·ªìng th·ªùi ghi log BLOCKED v·ªõi matched_rule.

- N·∫øu browser t·ª± encode/normalize kh√°c, d√πng curl v·ªõi %0d%0a l√† an to√†n.

**K·∫øt qu·∫£ mong ƒë·ª£i**: 
- 403 + log BLOCKED; admin-ui / admin_api s·∫Ω hi·ªÉn th·ªã entry c√≥ CRLF_INJECTION.

PowerShell (GET, query-encoded):
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/search?q=%0d%0aSet-Cookie:evil=1" -Method Get -ErrorAction SilentlyContinue
```

curl:
```
curl -i "http://127.0.0.1:5000/search?q=%0d%0aSet-Cookie:evil=1"
```

PowerShell (POST body with raw CRLF ‚Äî may be tricky in console; better send encoded):
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/comment" -Method Post -Body "%0d%0aLocation:http://evil.exampl
```

### 2) XPath / LDAP injection hint (rule id 12)

M·ª•c ti√™u: g·ª≠i payload c√≥ ch·ªØ xpath/ldap ho·∫∑c filter=(...) v√≠ d·ª• XPath expression. M√¥ ph·ªèng payload c√≥ d·∫°ng XPath expression ho·∫∑c c√°c chu·ªói li√™n quan xpath, ldap, filter= ‚Üí d√πng ƒë·ªÉ th·ª≠ t·∫•n c√¥ng XML/XPath/LDAP injection (khi backend x·ª≠ l√Ω XML/LDAP).

Rule li√™n quan: XPATH_LDAP_INJECTION

Pattern: (?:\b(xpath|ldap)\b|filter=\(|\[\*\])

C√°ch ho·∫°t ƒë·ªông & l∆∞u √Ω:

- Payload kh√¥ng tr·ª±c ti·∫øp g√¢y l·ªói tr√™n app demo (app ch·ªâ hi·ªÉn th·ªã query) ‚Äî m·ª•c ƒë√≠ch demo l√† ƒë·ªÉ WAF log/alert cho pattern n√†y.

- Rule m·∫∑c ƒë·ªãnh trong file c√≥ th·ªÉ ƒëang disabled; b·∫≠t tr∆∞·ªõc khi demo n·∫øu mu·ªën block.

K·∫øt qu·∫£ mong ƒë·ª£i:

- N·∫øu rule enabled ‚Üí 403 + log BLOCKED.

- N·∫øu rule disabled ‚Üí request ƒëi qua (200) v√† admin logs ghi ALLOWED.

**K·∫øt qu·∫£ mong ƒë·ª£i:**

- N·∫øu rule enabled ‚Üí 403 + log BLOCKED.

- N·∫øu rule disabled ‚Üí request ƒëi qua (200) v√† admin logs ghi ALLOWED.

PowerShell (GET):
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/search?q=filter=(//* )[1]" -Method Get -ErrorAction SilentlyContinue
```

curl:
```
curl -i -G "http://127.0.0.1:5000/search" --data-urlencode "q=filter=(//* )[1]"
```

### 3) Suspicious long token (rule id 13)

M·ª•c ti√™u: g·ª≠i chu·ªói >=80 k√Ω t·ª± (alnum/_/-) ƒë·ªÉ k√≠ch ho·∫°t.

Gi·∫£ l·∫≠p chu·ªói d√†i kh·∫£ nghi (base64, shellcode, long token) ‚Äî rule c·∫£nh b√°o khi c√≥ chu·ªói alnum >= 80 k√Ω t·ª±. D√πng ƒë·ªÉ ph√°t hi·ªán payload d√†i b·∫•t th∆∞·ªùng.

Rule li√™n quan: SUSPICIOUS_LONG_TOKEN

Pattern: [A-Za-z0-9\-_]{80,}

C√°ch ho·∫°t ƒë·ªông & l∆∞u √Ω:

- V√¨ d·ªÖ false positive (v√≠ d·ª• JWT, API token), rule th∆∞·ªùng disabled ho·∫∑c ch·ªâ log.

- D√πng POST body gi√∫p tr√°nh URL encoding issues.

K·∫øt qu·∫£ mong ƒë·ª£i:

- N·∫øu rule enabled ‚Üí 403; th∆∞·ªùng demo s·∫Ω ƒë·ªÉ rule disabled v√† xem log ƒë·ªÉ minh h·ªça c·∫£nh b√°o.

PowerShell (POST with long token in body):
```
# t·∫°o token 90 k√Ω t·ª±
$tok = ('A' * 90)
Invoke-RestMethod -Uri "http://127.0.0.1:5000/redeem" -Method Post -Body $tok -ContentType "text/plain" -ErrorAction SilentlyContinue
```

curl:
```
curl -i -X POST "http://127.0.0.1:5000/redeem" --data "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
```

### 4) SQL comment / obfuscation (rule id 14)

M·ª•c ti√™u: ch·ª©a /* ... */ trong input.
- /* ... */ l√† k·ªπ thu·∫≠t obfuscation t·∫•n c√¥ng SQL (c·ªë t√¨nh ch√®n comment ƒë·ªÉ n√© b·ªô l·ªçc).

- UNION SELECT ... m√¥ ph·ªèng SQL injection ki·ªÉu union-based ƒë·ªÉ tr√≠ch d·ªØ li·ªáu.

Rule li√™n quan:
- SQL_COMMENT_OBFUSCATION pattern: (?:/\*.*?\*/)

- SQLi pattern (seed/analyzer): (?:union\s+select\b) ho·∫∑c analyzer-generated (UNION|SELECT).*FROM

**K·∫øt qu·∫£ mong ƒë·ª£i:**

- N·∫øu rule enabled ‚Üí 403 + BLOCKED log.

- N·∫øu rule disabled ‚Üí request ƒëi qua; analyzer sau n√†y c√≥ th·ªÉ t·∫°o rule n·∫øu nhi·ªÅu BLOCKs xu·∫•t hi·ªán.

PowerShell (GET):
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/search?q=1/*comment*/" -Method Get -ErrorAction SilentlyContinue
```

curl:
```
curl -i "http://127.0.0.1:5000/search?q=1/*comment*/" (SQL comment obfuscation)
```

Ta c≈©ng c√≥ th·ªÉ th·ª≠ typical SQL payloads:
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/search?q=UNION+SELECT+password+FROM+users" -Method Get -ErrorAction SilentlyContinue (UNION-based SQLi)
```

### 5) Suspicious file extension (rule id 15)

M·ª•c ti√™u: truy c·∫≠p t·∫£i/ƒë∆∞·ªùng d·∫´n file .php, .jsp, .asp v.v.
- Ph√°t hi·ªán truy v·∫•n/ƒë∆∞·ªùng d·∫´n ch·ª©a extension th·ª±c thi server-side (.php, .jsp, .asp) ‚Äî th∆∞·ªùng li√™n quan upload shell ho·∫∑c truy c·∫≠p file th·ª±c thi.

- K·∫øt h·ª£p v·ªõi path traversal (../) c√≥ th·ªÉ d·∫´n t·ªõi LFI/RFI.

Rule li√™n quan: SUSPICIOUS_FILE_EXT v√† PATH_TRAVERSAL

- SUSPICIOUS_FILE_EXT pattern: (?:\.phps?|\.phtml|\.jsp|\.asp[x]?)$

- PATH_TRAVERSAL pattern: (?:%2e%2e%2f|%2e%2e\/|\.{2}%2f|\.{2}\/) ho·∫∑c (\.\./|/etc/passwd|/proc/self/environ)

C√°ch ho·∫°t ƒë·ªông & l∆∞u √Ω:

- ƒê·ªÉ trigger, g·ª≠i t√™n file trong query/path.

- C√≥ th·ªÉ c·∫ßn toLower/normalize ƒë·ªÉ match encoded sequences.

**K·∫øt qu·∫£ mong ƒë·ª£i**: 403 + BLOCKED log n·∫øu rule enabled.

PowerShell (GET):
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/download?file=shell.php" -Method Get -ErrorAction SilentlyContinue
```

curl:
```
curl -i "http://127.0.0.1:5000/download?file=shell.php"
```

Ho·∫∑c path traversal test:
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/search?q=../../etc/passwd" -Method Get -ErrorAction SilentlyContinue
```

### 6) Command injection pattern (rule id 16)

M·ª•c ti√™u: ch√®n ; ls ho·∫∑c | whoami v.v. M√¥ ph·ªèng command injection ‚Äî ch√®n shell metacharacters (;, |) k√®m l·ªánh (whoami, ls, cat, rm), c·ªë g·∫Øng th·ª±c thi l·ªánh tr√™n server.

Rule li√™n quan: regex pattern: ([;&|]{1,2}\s*(cat|ls|whoami|id|rm)\b)

C√°ch ho·∫°t ƒë·ªông & l∆∞u √Ω:

- Rule c√≥ th·ªÉ d·ªÖ false-positive n·∫øu ·ª©ng d·ª•ng ch·∫•p nh·∫≠n chu·ªói nh∆∞ a|b h·ª£p l·ªá; c√¢n nh·∫Øc b·∫≠t ch·ªâ ·ªü m√¥i tr∆∞·ªùng nh·∫°y c·∫£m.

- G·ª≠i POST body ho·∫∑c encoded GET ƒë·ªÉ ƒë·∫£m b·∫£o WAF nh·∫≠n ƒë√∫ng chu·ªói.

**K·∫øt qu·∫£ mong ƒë·ª£i**: 403 + BLOCKED log khi match.


PowerShell (GET with encoded characters):
```
# d√πng --data-urlencode with curl style via Invoke-RestMethod not trivial; use curl for simplicity:
curl -i "http://127.0.0.1:5000/search?q=%3B%20ls%20-l"
```

curl raw:
```
curl -i "http://127.0.0.1:5000/search?q=%3B%20whoami"
```

PowerShell using POST body (raw semicolon):
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/comment" -Method Post -Body "; ls -la" -ContentType "text/plain" -ErrorAction SilentlyContinue
```

### 7) XSS with <script> (rule id 17)

M·ª•c ti√™u: g·ª≠i <script>...</script> trong body (POST) ho·∫∑c query. M√¥ ph·ªèng Cross-Site Scripting (XSS) ki·ªÉu ch√®n th·∫ª <script> trong input, mu·ªën ch·∫°y script tr√™n tr√¨nh duy·ªát n·∫°n nh√¢n.

Rule li√™n quan: XSS_ATTACK / XSS

Pattern: <script[^>]*?>[\s\S]*?<\/script> ho·∫∑c <script.*?>.*?</script>

C√°ch ho·∫°t ƒë·ªông & l∆∞u √Ω:

- POST body th∆∞·ªùng √≠t b·ªã encoding, d·ªÖ trigger.

- WAF decode/normalize tr∆∞·ªõc khi match; nhi·ªÅu WAF c√≤n √°p th√™m HTML-entity decode ƒë·ªÉ b·∫Øt evasion (&lt;script&gt;).

**K·∫øt qu·∫£ mong ƒë·ª£i**: 403 + BLOCKED log.

PowerShell (POST body):
```
Invoke-RestMethod -Uri "http://127.0.0.1:5000/comment" -Method Post -Body "<script>alert('xss')</script>" -ContentType "text/plain" -ErrorAction SilentlyContinue
```

curl:
```
curl -i -X POST "http://127.0.0.1:5000/comment" -H "Content-Type: text/plain" --data "<script>alert('xss')</script>"
```

GET variant (encoded):
```
curl -i "http://127.0.0.1:5000/search?q=%3Cscript%3Ealert(1)%3C%2Fscript%3E"
```

### Ki·ªÉm tra k·∫øt qu·∫£

- N·∫øu rule match ‚Üí WAF tr·∫£ HTTP 403 v·ªõi JSON ch·ª©a "message": "Blocked by WAF (rule ...)".

- Ki·ªÉm tra log JSON file backend/logs/waf.log ho·∫∑c Admin API GET /api/logs.

- Admin UI (http://localhost:8080) ‚Üí Load Logs / Load Rules s·∫Ω hi·ªÉn th·ªã c·∫≠p nh·∫≠t.

- D√πng Admin API:

    - Rules: curl "http://127.0.0.1:5002/api/rules"

    - Logs: curl "http://127.0.0.1:5002/api/logs"

### L∆∞u √Ω / Troubleshoot nhanh

- N·∫øu request b·ªã browser auto-encode (GET), d√πng POST body ƒë·ªÉ ƒë·∫£m b·∫£o chu·ªói kh√¥ng b·ªã encode.

- M·ªôt v√†i pattern (v√≠ d·ª• long token) c√≥ th·ªÉ b·ªã disabled (enabled: false) ‚Äî check rules.json tr∆∞·ªõc.

- N·∫øu Admin API CORS l·ªói khi d√πng admin-ui, ch·∫Øc ch·∫Øn admin_api.py ƒë√£ CORS(app).

- ƒê·ªÉ tr√°nh false-positive th·ª≠ t·ª´ng rule 1-1 v·ªõi payload nh·ªè g·ªçn.

- Tr∆∞·ªõc demo, enalbe/disable rule mong mu·ªën b·∫±ng s·ª≠a rules.json ƒë·ªÉ minh ho·∫° block vs allow. (ho·∫∑c d√πng UI n·∫øu c√≥ endpoint toggle).

- D√πng POST body khi b·∫°n c·∫ßn payload kh√¥ng b·ªã URL-encoding.

- Ki·ªÉm so√°t false positives: m·ªôt v√†i rule (long token, cmd injection, xpath...) t·ªët nh·∫•t ƒë·ªÉ enabled: false v√† ch·ªâ log ƒë·ªÉ ph√≤ng FP trong demo n·∫øu backend gi·∫£ l·∫≠p c√≥ input h·ª£p l·ªá.

- Analyzer: n·∫øu b·∫°n mu·ªën t·ª± ƒë·ªông sinh rule t·ª´ logs, ch·∫°y GET /api/analyze sau khi c√≥ nhi·ªÅu BLOCK ƒë·ªÉ xem n√≥ th√™m rule v√†o rules.json.